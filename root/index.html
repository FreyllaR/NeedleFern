<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeedleFern - Shop Catalogue</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è (CSS) --- */
        :root {
            --text-color: #222222;
            --gray-text: #595959;
            --border-color: #e1e3df;
            --btn-border: #222;
            --bg-color: rgba(255, 255, 255, 0.85);
            --hover-color: #f1f2f0;
            --accent-color: #2196f3;
            --delete-color: #d9534f;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

            --font-main: 'Dancing Script', cursive;
            --font-sans: 'Roboto', Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-sans);
            color: var(--text-color);
            line-height: 1.5;
            background-image: url('https://via.placeholder.com/1920x1080/e0d4c5/404040?text=Embroidery+Background');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        .content-wrapper {
            background-color: var(--bg-color);
            padding-bottom: 50px;
            min-height: 100vh;
        }

        h1, h2 { font-family: var(--font-main); font-weight: 700; }

        a { text-decoration: none; color: inherit; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* –®–∞–ø–∫–∞ –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .shop-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 24px 0; }
        .shop-info { display: flex; gap: 16px; }
        .shop-logo { width: 80px; height: 80px; border-radius: 4px; object-fit: cover; border: 1px solid var(--border-color); }
        .shop-details h1 { font-size: 40px; margin-bottom: 4px; }
        .shop-location { color: var(--gray-text); font-size: 14px; }

        .shop-actions { display: flex; gap: 15px; }

        .btn {
            padding: 10px 20px; border-radius: 4px; border: 1px solid var(--btn-border); background: white; font-weight: 700;
            font-size: 20px; cursor: pointer; transition: background 0.2s, border-color 0.2s; display: flex;
            align-items: center; gap: 8px; position: relative; font-family: var(--font-main);
        }
        .btn:hover { background-color: var(--hover-color); border-color: #000; }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ */
        .btn.pulse { animation: pulse-animation 0.5s ease-in-out; }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Dropdown –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; right: 0; background-color: #fff; min-width: 160px;
            box-shadow: var(--shadow); z-index: 1; border-radius: 4px; border: 1px solid var(--border-color);
            overflow: hidden; margin-top: 0; padding-top: 5px;
        }
        .dropdown-content a {
            color: var(--text-color); padding: 12px 16px; text-decoration: none; display: flex;
            align-items: center; gap: 10px; font-size: 16px; font-family: var(--font-sans);
        }
        .dropdown-content a:hover { background-color: var(--hover-color); }
        .dropdown:hover .dropdown-content { display: block; }

        /* –°—Ç–∏–ª—å –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–æ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ */
        .flying-product-clone {
            position: fixed; z-index: 9999; width: 100px; height: 100px; object-fit: cover;
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); pointer-events: none;
        }

        /* –°—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã */
        #cart-count {
            position: absolute; top: -5px; right: -5px; background-color: var(--delete-color); color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: 700; font-family: var(--font-sans); line-height: 1;
        }

        .sticky-nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; padding-bottom: 8px; }
        .search-bar { background-color: var(--hover-color); border-radius: 4px; padding: 8px 16px; display: flex; align-items: center; width: 300px; border: 1px solid transparent; }
        .search-bar input { border: none; background: transparent; width: 100%; outline: none; margin-left: 8px; font-size: 14px; font-family: var(--font-sans); }

        /* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
        .sort-dropdown { font-family: var(--font-sans); font-weight: 400; font-size: 16px; position: relative; cursor: pointer; }
        .sort-dropdown select { border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-family: var(--font-sans); outline: none; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ –∏ –î–µ—Ç–∞–ª–∏ */
        #product-list-view { display: block; }
        .products-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .products-header h2 { font-size: 30px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; }
        .product-card { cursor: pointer; }
        .product-image { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 10px; transition: opacity 0.2s; }
        .product-card:hover .product-image { opacity: 0.85; }
        .product-title { font-family: var(--font-sans); font-size: 15px; color: var(--text-color); margin-bottom: 4px; line-height: 1.2; }
        .product-price { font-weight: 500; font-size: 16px; }
        .digital-tag { font-size: 12px; color: var(--gray-text); margin-top: 2px; display: flex; align-items: center; gap: 4px; }

        #product-detail-view, #cart-view { display: none; padding: 20px 0; }
        .back-to-shop-btn {
            background: none; border: none; color: var(--text-color); font-size: 16px; cursor: pointer; margin-bottom: 30px;
            display: flex; align-items: center; gap: 8px; padding: 5px 10px; border-radius: 4px; transition: background 0.2s;
        }
        .back-to-shop-btn:hover { background-color: var(--hover-color); }
        .detail-card-content { display: flex; gap: 40px; border: 1px solid var(--border-color); padding: 20px; border-radius: 4px; background-color: #fff; }
        .detail-image-wrapper { flex: 1; max-width: 500px; }
        .detail-image { width: 100%; max-height: 600px; object-fit: contain; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .detail-info { flex: 1; }
        .detail-title { font-size: 32px; margin-bottom: 15px; line-height: 1.2; }
        .detail-price { font-size: 28px; font-weight: 700; margin-bottom: 15px; color: var(--text-color); }
        .detail-description { margin-bottom: 25px; color: var(--gray-text); font-size: 16px; line-height: 1.4; }

        /* –ö–æ—Ä–∑–∏–Ω–∞ */
        .cart-btn { background-color: var(--accent-color); color: white; padding: 15px 30px; border: none; border-radius: 4px; font-size: 18px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 10px; }
        .cart-btn:hover { background-color: #1e88e5; }
        .cart-item { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 15px 0; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-title { font-size: 16px; font-weight: 500; }
        .cart-item-price { font-size: 15px; color: var(--gray-text); }
        .cart-item-actions { display: flex; align-items: center; gap: 10px; font-size: 16px; min-width: 250px; justify-content: flex-end; }

        .quantity-controls { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 4px; }
        .quantity-btn {
            background: none; border: none; cursor: pointer; font-size: 18px; font-weight: 700;
            padding: 5px 10px; color: var(--text-color); transition: background-color 0.1s;
        }
        .quantity-btn:hover { background-color: var(--hover-color); }
        .quantity-display { padding: 0 10px; font-weight: 500; }

        .item-subtotal { min-width: 80px; text-align: right; font-weight: 700; }

        .delete-item-btn { background: none; border: none; color: var(--delete-color); cursor: pointer; font-size: 20px; padding: 5px; transition: color 0.2s; }
        .delete-item-btn:hover { color: darkred; }
        .cart-summary { margin-top: 30px; padding: 20px; border: 1px solid var(--border-color); background-color: var(--hover-color); text-align: right; border-radius: 4px; }
        .cart-total { font-size: 24px; font-weight: 700; font-family: var(--font-sans); }

        .loading-message, .error-message { text-align: center; padding: 50px; font-size: 18px; color: var(--gray-text); }
        .error-message { color: red; background-color: #ffeeee; border: 1px solid red; }

        @media (max-width: 900px) { .detail-card-content { flex-direction: column; } }

        /* –°—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —è–∑—ã–∫–∞ */
        .language-switcher {
            position: fixed; bottom: 20px; right: 20px; background-color: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 8px; box-shadow: var(--shadow); z-index: 1000; display: flex; gap: 5px;
        }
        .language-switcher button {
            background: none; border: none; cursor: pointer; padding: 5px 8px; font-size: 14px; font-weight: 500;
            opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; border-radius: 3px;
        }
        .language-switcher button:hover { opacity: 1; background-color: var(--hover-color); }
        .language-switcher button.active { opacity: 1; font-weight: 700; background-color: var(--accent-color); color: white; }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê CHECKOUT --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            margin: 20px 0;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-text);
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: var(--delete-color);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ */
        #checkout-form input[type="text"],
        #checkout-form input[type="email"] {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
            margin-top: 5px;
        }

        #checkout-summary-final {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: right;
            margin-top: 20px;
        }

    </style>
</head>
<body>

<div class="content-wrapper">
    <div class="container">
        <header class="shop-header">
            <div class="shop-info">
                <img src="logo.png" alt="NeedleFern Logo" class="shop-logo">
                <div class="shop-details">
                    <h1>NeedleFern</h1>
                    <p class="shop-location" data-translate="location">–ë–µ–ª–≥—Ä–∞–¥, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –°–µ—Ä–±–∏—è</p>
                </div>
            </div>

            <div class="shop-actions">
                <div class="dropdown">
                    <button class="btn"><i class="fa-solid fa-share-nodes"></i> <span data-translate="btn_social">–°–æ—Ü. —Å–µ—Ç–∏</span></button>
                    <div class="dropdown-content">
                        <a href="https://www.facebook.com/profile.php?id=61569760749303&ref=fb_bidir_ig_profile_ac" target="_blank">
                            <i class="fa-brands fa-facebook"></i> Facebook
                        </a>
                        <a href="https://www.instagram.com/needle_fern/" target="_blank">
                            <i class="fa-brands fa-instagram"></i> Instagram
                        </a>
                        <a href="https://t.me/Needle_Fern" target="_blank">
                            <i class="fa-brands fa-telegram"></i> Telegram
                        </a>
                        <a href="https://needlefern.etsy.com" target="_blank">
                            <i class="fa-solid fa-store"></i> Etsy
                        </a>
                    </div>
                </div>

                <button class="btn" onclick="showCartView()" id="cart-button">
                    <i class="fa-solid fa-cart-shopping"></i> <span data-translate="btn_cart">–ö–æ—Ä–∑–∏–Ω–∞</span>
                    <span id="cart-count" style="display: none;">0</span>
                </button>
            </div>
        </header>
        <nav class="sticky-nav">
            <div class="nav-links">
                <a class="nav-link active" data-translate="nav_products">–¢–æ–≤–∞—Ä—ã</a>
            </div>

            <div class="search-bar">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º..." onkeyup="filterProducts()">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
        </nav>

        <div class="main-layout">
            <main>

                <section id="product-list-view">
                    <div class="products-header">
                        <h2><span data-translate="h2_recommended">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</span> (<span id="product-count">0</span>)</h2>
                        <div class="sort-dropdown">
                            <span data-translate="sort_label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                            <select id="sort-select" onchange="sortProducts(this.value)">
                                <option value="default" data-translate="sort_default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                <option value="price_asc" data-translate="sort_price_asc">–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ)</option>
                                <option value="price_desc" data-translate="sort_price_desc">–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ)</option>
                            </select>
                        </div>
                    </div>
                    <div id="product-grid" class="product-grid">
                        </div>
                </section>

                <section id="product-detail-view">
                    <button class="back-to-shop-btn" onclick="showListView()">
                        <i class="fa-solid fa-arrow-left"></i> <span data-translate="btn_back_shop">–ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω</span>
                    </button>

                    <div class="detail-card-content">
                        <div class="detail-image-wrapper">
                            <img id="detail-image" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="detail-image">
                        </div>

                        <div class="detail-info">
                            <h2 id="detail-title" class="detail-title"></h2>
                            <div id="detail-price" class="detail-price"></div>

                            <p id="detail-description" class="detail-description"></p>

                            <button class="cart-btn" id="add-to-cart-detail">
                                <i class="fa-solid fa-cart-shopping"></i> <span data-translate="btn_add_to_cart">–ü–æ–ª–æ–∂–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</span>
                            </button>

                            <p style="margin-top: 20px; font-size: 14px;">
                                <span data-translate="detail_availability">–ù–∞–ª–∏—á–∏–µ:</span> <span id="detail-quantity"></span><br>
                                ID: <span id="detail-id"></span>
                            </p>
                            <p style="margin-top: 15px; font-size: 14px; color: var(--gray-text);">
                                <i class="fa-solid fa-link"></i> <a id="detail-link" href="#" target="_blank" data-translate="detail_link">–ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ</a>
                            </p>
                        </div>
                    </div>
                </section>

                <section id="cart-view">
                    <button class="back-to-shop-btn" onclick="showListView()">
                        <i class="fa-solid fa-arrow-left"></i> <span data-translate="btn_continue_shop">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</span>
                    </button>

                    <div class="products-header">
                        <h2 data-translate="h2_cart">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                    </div>

                    <div id="cart-items-list">
                        </div>

                    <div id="cart-empty-message" style="text-align: center; padding: 50px; font-size: 18px; color: var(--gray-text); display: none;">
                        <i class="fa-solid fa-basket-shopping" style="font-size: 30px; margin-bottom: 10px;"></i>
                        <p data-translate="cart_empty">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
                    </div>

                    <div id="cart-summary" class="cart-summary" style="display: none;">
                        <p data-translate="cart_total">–ò—Ç–æ–≥–æ:</p>
                        <div id="cart-total-amount" class="cart-total">‚Ç¨ 0.00</div>
                        <button class="cart-btn" style="margin-top: 15px; width: 100%;" onclick="openCheckoutModal()">
                            <span data-translate="btn_checkout">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span>
                        </button>
                    </div>
                </section>

                <div id="status-message" class="loading-message">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
                </div>
            </main>
        </div>
    </div>
</div>

<div id="checkout-modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 data-translate="h2_checkout">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
            <button class="close-btn" onclick="closeCheckoutModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <form id="checkout-form">
            <h3 style="margin-bottom: 15px;" data-translate="h3_contact">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div style="margin-bottom: 15px;">
                <label for="name" style="display: block; margin-bottom: 5px;" data-translate="label_name">–ò–º—è:</label>
                <input type="text" id="name" required>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="email" style="display: block; margin-bottom: 5px;" data-translate="label_email">Email:</label>
                <input type="email" id="email" required>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;" data-translate="h3_payment">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
            <div style="margin-bottom: 20px;">
                <input type="radio" id="pay_paypal" name="payment_method" value="paypal" required checked>
                <label for="pay_paypal">PayPal / <span data-translate="pay_card">–ö–∞—Ä—Ç–∞</span></label><br>
                <input type="radio" id="pay_crypto" name="payment_method" value="crypto" disabled>
                <label for="pay_crypto">Crypto (<span data-translate="pay_soon">—Å–∫–æ—Ä–æ</span>)</label>
            </div>

            <div id="checkout-summary-final">
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 15px;">
                    <span data-translate="cart_total">–ò—Ç–æ–≥–æ:</span> <span id="checkout-final-amount">‚Ç¨ 0.00</span>
                </div>
                <button type="submit" class="cart-btn" style="width: 100%;" data-translate="btn_pay">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
            </div>
        </form>
    </div>
</div>
<div class="language-switcher" id="language-switcher">
    <button data-lang="ru">üá∑üá∫ RU</button>
    <button data-lang="en">üá¨üáß EN</button>
    <button data-lang="sr">üá∑üá∏ SR</button>
</div>

<script>
    // --- JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ ---

    // 1. –°–õ–û–í–ê–†–¨ –ü–ï–†–ï–í–û–î–û–í –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    const TRANSLATIONS = {
        'ru': {
            'h1_title': 'NeedleFern',
            'location': '–ë–µ–ª–≥—Ä–∞–¥, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –°–µ—Ä–±–∏—è',
            'btn_social': '–°–æ—Ü. —Å–µ—Ç–∏',
            'btn_cart': '–ö–æ—Ä–∑–∏–Ω–∞',
            'nav_products': '–¢–æ–≤–∞—Ä—ã',
            'search_placeholder': '–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º',
            'h2_recommended': '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã',
            'sort_label': '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:',
            'sort_default': '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é',
            'sort_price_asc': '–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ)',
            'sort_price_desc': '–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ)',
            'digital_tag': '–¶–∏—Ñ—Ä–æ–≤–æ–π —Ç–æ–≤–∞—Ä',
            'btn_back_shop': '–ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω',
            'btn_add_to_cart': '–ü–æ–ª–æ–∂–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É',
            'detail_availability': '–ù–∞–ª–∏—á–∏–µ:',
            'detail_not_available': '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏',
            'detail_link': '–ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ',
            'h2_cart': '–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞',
            'btn_continue_shop': '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏',
            'cart_empty': '–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.',
            'cart_total': '–ò—Ç–æ–≥–æ:',
            'btn_checkout': '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑',
            'status_loading': '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...',
            'status_error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:',

            // –ù–û–í–´–ï –ü–ï–†–ï–í–û–î–´ –î–õ–Ø CHECKOUT
            'btn_back_cart': '–ù–∞–∑–∞–¥ –≤ –∫–æ—Ä–∑–∏–Ω—É',
            'h2_checkout': '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
            'h3_contact': '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
            'label_name': '–ò–º—è:',
            'label_email': 'Email:',
            'h3_payment': '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
            'pay_card': '–ö–∞—Ä—Ç–∞',
            'pay_soon': '—Å–∫–æ—Ä–æ',
            'btn_pay': '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ',

            'productTitles': {
                1001: '–í—ã—à–∏–≤–∫–∞ "–°–Ω–µ–≥–æ–≤–∏–∫" (–°—Ö–µ–º–∞)',
                1002: '–°—Ö–µ–º–∞ –≤—ã—à–∏–≤–∫–∏ "–í–∏–Ω—Ç–∞–∂–Ω—ã–π —Å–∞–º–æ–ª—ë—Ç"',
                1003: '–°—Ö–µ–º–∞ –≤—ã—à–∏–≤–∫–∏ "–†–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–∏–π –∫–æ–ª–æ–∫–æ–ª"',
                1004: '–°—Ö–µ–º–∞ –≤—ã—à–∏–≤–∫–∏ "–°–∞–Ω–∏ –°–∞–Ω—Ç—ã"',
            },
            'productDescriptions': {
                1001: '–û—á–∞—Ä–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –≤—ã—à–∏–≤–∫–∏ –∫—Ä–µ—Å—Ç–æ–º –∏ –≤—è–∑–∞–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≤–µ—Å–µ–ª–æ–≥–æ —Å–Ω–µ–≥–æ–≤–∏–∫–∞, –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –∑–∏–º–Ω–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤. –õ–µ–≥–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.',
                1002: '–°–ª–æ–∂–Ω–∞—è –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –≤–∏–Ω—Ç–∞–∂–Ω–æ–≥–æ —Å–∞–º–æ–ª–µ—Ç–∞. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤. –ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π –∞–≤–∏–∞—Ü–∏–∏.',
                1003: '–ü—Ä–æ—Å—Ç–∞—è –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è —Å—Ö–µ–º–∞ —Ä–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–æ–≥–æ –∫–æ–ª–æ–∫–æ–ª–∞. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —É–∫—Ä–∞—à–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–∫ –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø–æ–¥–∞—Ä–∫–æ–≤.',
                1004: '–°—Ö–µ–º–∞ –≤—ã—à–∏–≤–∫–∏ –∫—Ä–µ—Å—Ç–æ–º, –∏–∑–æ–±—Ä–∞–∂–∞—é—â–∞—è —Å–∞–Ω–∏ –°–∞–Ω—Ç—ã. –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –¥–∏–∑–∞–π–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.',
            }
        },
        'en': {
            'h1_title': 'NeedleFern',
            'location': 'Belgrade, Central Serbia',
            'btn_social': 'Social Media',
            'btn_cart': 'Cart',
            'nav_products': 'Products',
            'search_placeholder': 'Search all products',
            'h2_recommended': 'Featured Products',
            'sort_label': 'Sort by:',
            'sort_default': 'Default',
            'sort_price_asc': 'Price (low to high)',
            'sort_price_desc': 'Price (high to low)',
            'digital_tag': 'Digital Product',
            'btn_back_shop': 'Back to Shop',
            'btn_add_to_cart': 'Add to Cart',
            'detail_availability': 'Availability:',
            'detail_not_available': 'Out of stock',
            'detail_link': 'Go to external link',
            'h2_cart': 'Your Cart',
            'btn_continue_shop': 'Continue Shopping',
            'cart_empty': 'Your cart is empty.',
            'cart_total': 'Total:',
            'btn_checkout': 'Checkout',
            'status_loading': 'Loading products...',
            'status_error': 'Loading error:',

            // –ù–û–í–´–ï –ü–ï–†–ï–í–û–î–´ –î–õ–Ø CHECKOUT
            'btn_back_cart': 'Back to Cart',
            'h2_checkout': 'Checkout',
            'h3_contact': 'Contact Information',
            'label_name': 'Name:',
            'label_email': 'Email:',
            'h3_payment': 'Payment Method',
            'pay_card': 'Card',
            'pay_soon': 'soon',
            'btn_pay': 'Proceed to Payment',

            'productTitles': {
                1001: 'Snowman Cross Stitch and Knitting Pattern',
                1002: 'Vintage Airplane Cross Stitch Pattern',
                1003: 'Christmas Bell Cross Stitch Pattern',
                1004: 'Cross stitch pattern Santa\'s Sleigh',
            },
            'productDescriptions': {
                1001: 'A charming cross stitch and knitting pattern featuring a happy snowman, perfect for winter holidays. Easy difficulty level.',
                1002: 'A complex and detailed vintage airplane pattern. Suitable for experienced crafters. A wonderful gift for aviation enthusiasts.',
                1003: 'A simple and elegant Christmas bell pattern. Ideal for decorating cards and small gifts.',
                1004: 'A cross-stitch pattern depicting Santa\'s sleigh. A festive design to create a holiday mood.',
            }
        },
        'sr': {
            'h1_title': 'NeedleFern',
            'location': 'Beograd, Centralna Srbija',
            'btn_social': 'Dru≈°tvene mre≈æe',
            'btn_cart': 'Korpa',
            'nav_products': 'Proizvodi',
            'search_placeholder': 'Pretra≈æite sve proizvode',
            'h2_recommended': 'Izdvojeni proizvodi',
            'sort_label': 'Sortiraj po:',
            'sort_default': 'Podrazumevano',
            'sort_price_asc': 'Cena (rastuƒáa)',
            'sort_price_desc': 'Cena (opadajuƒáa)',
            'digital_tag': 'Digitalni proizvod',
            'btn_back_shop': 'Nazad u prodavnicu',
            'btn_add_to_cart': 'Dodaj u korpu',
            'detail_availability': 'Dostupnost:',
            'detail_not_available': 'Nema na stanju',
            'detail_link': 'Idi na link',
            'h2_cart': 'Va≈°a korpa',
            'btn_continue_shop': 'Nastavi kupovinu',
            'cart_empty': 'Va≈°a korpa je prazna.',
            'cart_total': 'Ukupno:',
            'btn_checkout': 'Plaƒáanje',
            'status_loading': 'Uƒçitavanje proizvoda...',
            'status_error': 'Gre≈°ka pri uƒçitavanju:',

            // –ù–û–í–´–ï –ü–ï–†–ï–í–û–î–´ –î–õ–Ø CHECKOUT
            'btn_back_cart': 'Nazad u korpu',
            'h2_checkout': 'Naplata',
            'h3_contact': 'Kontakt informacije',
            'label_name': 'Ime:',
            'label_email': 'Email:',
            'h3_payment': 'Naƒçin plaƒáanja',
            'pay_card': 'Kartica',
            'pay_soon': 'uskoro',
            'btn_pay': 'Nastavi na plaƒáanje',

            'productTitles': {
                1001: '≈†ema za vez "Sne≈°ko Beliƒá"',
                1002: '≈†ema za vez "Vintage Avion"',
                1003: '≈†ema za vez "Bo≈æiƒáno Zvono"',
                1004: '≈†ema za vez "Deda Mrazove Sanke"',
            },
            'productDescriptions': {
                1001: '≈†armantna ≈°ema za ukr≈°teni bod i pletenje sa veselim sne≈°kom, savr≈°ena za zimske praznike. Lak nivo te≈æine.',
                1002: 'Slo≈æena i detaljna ≈°ema vintage aviona. Pogodno za iskusne zanatlije. Prekrasan poklon za ljubitelje avijacije.',
                1003: 'Jednostavna i elegantna ≈°ema bo≈æiƒánog zvona. Idealno za ukra≈°avanje ƒçestitki i malih poklona.',
                1004: '≈†ema za ukr≈°teni bod koja prikazuje Deda Mrazove sanke. Prazniƒçni dizajn za stvaranje novogodi≈°njeg raspolo≈æenja.',
            }
        }
    };

    const API_URL = "http://127.0.0.1:8000/products";
    const CHECKOUT_URL = "http://127.0.0.1:8000/submit_order";

    let ALL_PRODUCTS = [];
    let DISPLAY_PRODUCTS = [];
    let CART = [];
    let CURRENT_PRODUCT = null;
    let CURRENT_LANGUAGE = localStorage.getItem('siteLang') || 'ru';

    const productListView = document.getElementById('product-list-view');
    const productDetailView = document.getElementById('product-detail-view');
    const cartView = document.getElementById('cart-view');
    const checkoutModal = document.getElementById('checkout-modal-overlay');
    const statusMessage = document.getElementById('status-message');
    const productGrid = document.getElementById('product-grid');
    const productCountSpan = document.getElementById('product-count');
    const searchInput = document.getElementById('search-input');
    const cartCountSpan = document.getElementById('cart-count');
    const addToCartDetailButton = document.getElementById('add-to-cart-detail');
    const sortSelect = document.getElementById('sort-select');
    const cartButton = document.getElementById('cart-button');


    // --- 1. –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –Ø–ó–´–ö–ê –ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

    function setLanguage(lang) {
        if (!TRANSLATIONS[lang]) return;

        CURRENT_LANGUAGE = lang;
        localStorage.setItem('siteLang', lang);

        const t = TRANSLATIONS[lang];

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-translate
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (t[key] !== undefined) {
                if (el.tagName === 'SPAN' || el.tagName === 'A' || el.tagName === 'P') {
                    el.textContent = t[key];
                } else if (el.tagName === 'BUTTON' || el.tagName === 'H2' || el.tagName === 'H3') {
                    let textNode = Array.from(el.childNodes).find(node => node.nodeType === 3);
                    if (textNode) {
                        textNode.nodeValue = t[key];
                    } else if (el.tagName === 'H2' && el.id !== 'detail-title') {
                        el.textContent = t.h2_recommended + ' (' + productCountSpan.textContent + ')';
                    } else if (el.tagName === 'H2' || el.tagName === 'H3') {
                        el.textContent = t[key];
                    } else if (el.querySelector('span')) {
                        el.querySelector('span').textContent = t[key];
                    } else {
                         el.textContent = t[key];
                    }
                } else if (el.tagName === 'LABEL') {
                    el.textContent = t[key];
                }
            }
        });

        // –û—Ç–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        searchInput.placeholder = t.search_placeholder + ` (${ALL_PRODUCTS.length})`;

        // –û—Ç–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø—Ü–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        document.querySelector('#sort-select option[value="default"]').textContent = t.sort_default;
        document.querySelector('#sort-select option[value="price_asc"]').textContent = t.sort_price_asc;
        document.querySelector('#sort-select option[value="price_desc"]').textContent = t.sort_price_desc;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('#language-switcher button').forEach(button => {
            button.classList.remove('active');
            if (button.dataset.lang === lang) {
                button.classList.add('active');
            }
        });

        // –ü–ï–†–ï–†–ò–°–û–í–ö–ê –í–°–ï–• –í–ò–î–û–í –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ù–ê–ó–í–ê–ù–ò–ô –¢–û–í–ê–†–û–í
        if (productListView.style.display === 'block') {
            renderProducts(DISPLAY_PRODUCTS);
        }
        if (productDetailView.style.display === 'block' && CURRENT_PRODUCT) {
            showDetailView(CURRENT_PRODUCT);
        }
        if (cartView.style.display === 'block') {
            renderCart();
        }
        if (statusMessage.style.display === 'block') {
            statusMessage.textContent = statusMessage.classList.contains('error-message') ? t.status_error : t.status_loading;
        }
        if (checkoutModal.style.display === 'flex') { // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞
            openCheckoutModal(true);
        }
    }


    function hideAllViews() {
        productListView.style.display = 'none';
        productDetailView.style.display = 'none';
        cartView.style.display = 'none';
        statusMessage.style.display = 'none';
    }

    function showListView() {
        hideAllViews();
        closeCheckoutModal();
        productListView.style.display = 'block';
        filterProducts();
        window.scrollTo(0, 0);
    }

    function showDetailView(product) {
        hideAllViews();
        closeCheckoutModal();
        productDetailView.style.display = 'block';
        CURRENT_PRODUCT = product;
        window.scrollTo(0, 0);

        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        const imageUrl = product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/500?text=No+Image';
        const detailImageEl = document.getElementById('detail-image');
        detailImageEl.src = imageUrl;

        const translatedTitle = t.productTitles[product.id] || product.title;
        document.getElementById('detail-title').textContent = translatedTitle;

        const translatedDescription = t.productDescriptions[product.id] || product.description || "No description available.";
        document.getElementById('detail-description').textContent = translatedDescription;

        document.getElementById('detail-price').textContent = `‚Ç¨ ${product.price}`;

        document.getElementById('detail-quantity').textContent = product.quantity > 0
            ? product.quantity
            : t.detail_not_available;

        document.getElementById('detail-id').textContent = product.id;
        document.getElementById('detail-link').href = product.url;

        addToCartDetailButton.onclick = () => {
            flyToCart(detailImageEl);
            addToCart(CURRENT_PRODUCT.id);
        };
    }

    function showCartView() {
        hideAllViews();
        closeCheckoutModal();
        cartView.style.display = 'block';
        renderCart();
        window.scrollTo(0, 0);
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    function openCheckoutModal(isLanguageChange = false) {
        if (CART.length === 0) {
            alert(TRANSLATIONS[CURRENT_LANGUAGE]['cart_empty']);
            return;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        const total = CART.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
        document.getElementById('checkout-final-amount').textContent = `‚Ç¨ ${total.toFixed(2)}`;

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('checkout-form').onsubmit = (e) => {
            e.preventDefault();
            submitOrder();
        };

        checkoutModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    function closeCheckoutModal() {
        checkoutModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // --- 2. –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ ---

    function updateCartCount() {
        const totalItems = CART.reduce((sum, item) => sum + item.quantity, 0);
        cartCountSpan.textContent = totalItems;
        cartCountSpan.style.display = totalItems > 0 ? 'block' : 'none';
    }

    function addToCart(productId) {
        const existingItem = CART.find(item => item.id === productId);

        if (existingItem) {
            increaseQuantity(productId, true);
        } else {
            const product = ALL_PRODUCTS.find(p => p.id === productId);
            if (product) {
                if (product.quantity > 0) {
                    CART.push({ ...product, quantity: 1 });
                } else {
                    console.warn(`Product ${productId} is out of stock.`);
                    return;
                }
            }
        }
        updateCartCount();
    }

    function increaseQuantity(productId, silent = false) {
        const item = CART.find(item => item.id === productId);
        const maxQuantity = ALL_PRODUCTS.find(p => p.id === productId)?.quantity || Infinity;
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        if (item && item.quantity < maxQuantity) {
            item.quantity += 1;
        } else if (item && item.quantity >= maxQuantity && !silent) {
            alert("–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. (" + t.detail_not_available + ")");
        }

        updateCartCount();
        if (document.getElementById('cart-view').style.display === 'block') {
            renderCart();
        }
        if (checkoutModal.style.display === 'flex') {
            openCheckoutModal(true);
        }
    }

    function decreaseQuantity(productId) {
        const itemIndex = CART.findIndex(item => item.id === productId);

        if (itemIndex > -1) {
            if (CART[itemIndex].quantity > 1) {
                CART[itemIndex].quantity -= 1;
            } else {
                CART.splice(itemIndex, 1);
            }
        }
        updateCartCount();
        if (document.getElementById('cart-view').style.display === 'block') {
            renderCart();
        }
        if (checkoutModal.style.display === 'flex') {
            openCheckoutModal(true);
        }
    }

    function removeFromCart(productId) {
        CART = CART.filter(item => item.id !== productId);
        updateCartCount();
        if (document.getElementById('cart-view').style.display === 'block') {
            renderCart();
        }
        if (checkoutModal.style.display === 'flex') {
            openCheckoutModal(true);
        }
    }

    function renderCart() {
        const cartList = document.getElementById('cart-items-list');
        const cartSummary = document.getElementById('cart-summary');
        const cartEmptyMessage = document.getElementById('cart-empty-message');
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        cartList.innerHTML = '';

        if (CART.length === 0) {
            cartEmptyMessage.style.display = 'block';
            cartSummary.style.display = 'none';
            return;
        }

        cartEmptyMessage.style.display = 'none';
        let total = 0;

        CART.forEach(item => {
            const itemPrice = parseFloat(item.price);
            const subtotal = itemPrice * item.quantity;
            total += subtotal;

            const translatedTitle = t.productTitles[item.id] || item.title;

            const cartItemDiv = document.createElement('div');
            cartItemDiv.className = 'cart-item';

            const imageUrl = item.images.length > 0 ? item.images[0] : 'https://via.placeholder.com/80?text=No+Image';

            cartItemDiv.innerHTML = `
                <img src="${imageUrl}" alt="${item.title}" class="cart-item-image">
                <div class="cart-item-details">
                    <div class="cart-item-title">${translatedTitle}</div>
                    <div class="cart-item-price">‚Ç¨ ${item.price}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decreaseQuantity(${item.id})">-</button>
                        <span class="quantity-display">${item.quantity}</span>
                        <button class="quantity-btn" onclick="increaseQuantity(${item.id})">+</button>
                    </div>
                    <span class="item-subtotal">‚Ç¨ ${subtotal.toFixed(2)}</span>
                    <button class="delete-item-btn" onclick="removeFromCart(${item.id})">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `;
            cartList.appendChild(cartItemDiv);
        });

        document.getElementById('cart-total-amount').textContent = `‚Ç¨ ${total.toFixed(2)}`;
        cartSummary.style.display = 'block';
    }


    // --- 3. –õ–û–ì–ò–ö–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê ---

    async function submitOrder() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        if (!name || !email || !paymentMethod) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!");
            return;
        }

        const items = CART.map(item => ({
            id: item.id,
            quantity: item.quantity
        }));

        const orderData = { name, email, payment_method: paymentMethod, items };

        // –í—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
        const payButton = document.querySelector('#checkout-form button[type="submit"]');
        payButton.disabled = true;
        payButton.textContent = "Processing...";

        try {
            const response = await fetch(CHECKOUT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (!response.ok) {
                const errorMessage = result.detail || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.';
                throw new Error(errorMessage);
            }

            // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            alert(`${t.h2_checkout}: #${result.order_id} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! (${result.message}). –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!`);

            // –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã, –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–∞–≥–∞–∑–∏–Ω
            CART = [];
            closeCheckoutModal();
            updateCartCount();
            showListView();

        } catch (error) {
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.`);
            console.error('Checkout Error:', error);
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            payButton.disabled = false;
            payButton.textContent = t.btn_pay;
        }
    }


    // --- 4. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

    function flyToCart(sourceEl) {
        if (!sourceEl || !(sourceEl instanceof HTMLImageElement)) { return; }

        const rect = sourceEl.getBoundingClientRect();
        const cartRect = cartButton.getBoundingClientRect();

        const flyingEl = sourceEl.cloneNode(true);
        flyingEl.classList.add('flying-product-clone');
        flyingEl.style.left = rect.left + 'px';
        flyingEl.style.top = rect.top + 'px';
        flyingEl.style.width = rect.width + 'px';
        flyingEl.style.height = rect.height + 'px';
        flyingEl.style.opacity = '1';
        document.body.appendChild(flyingEl);

        const targetX = cartRect.left + (cartRect.width / 2) - (rect.width / 2);
        const targetY = cartRect.top + (cartRect.height / 2) - (rect.height / 2);

        const animation = flyingEl.animate([
            { transform: `translate(0, 0) scale(1)`, opacity: 1, borderRadius: '8px' },
            { transform: `translate(${targetX - rect.left}px, ${targetY - rect.top}px) scale(0.1)`, opacity: 0, borderRadius: '50%' }
        ], {
            duration: 800,
            easing: 'ease-in-out',
            fill: 'forwards'
        });

        animation.onfinish = () => {
            flyingEl.remove();
            cartButton.classList.add('pulse');
            setTimeout(() => {
                cartButton.classList.remove('pulse');
            }, 500);
        };
    }

    function renderProducts(productsToRender) {
        productGrid.innerHTML = '';
        productCountSpan.textContent = productsToRender.length;
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        if (productsToRender.length === 0) {
            productGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; padding: 30px;">' + t.h2_recommended + ' ' + t.cart_empty.replace('–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.', '–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–±—Ä–æ—Å—å—Ç–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É.') + '</p>';
            return;
        }

        productsToRender.forEach(product => {
            productGrid.appendChild(createProductCard(product));
        });
    }

    function createProductCard(product) {
        const t = TRANSLATIONS[CURRENT_LANGUAGE];
        const card = document.createElement('article');
        card.className = 'product-card';
        card.onclick = () => showDetailView(product);

        const imageUrl = product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/300?text=No+Image';
        const isDigital = true;
        const translatedTitle = t.productTitles[product.id] || product.title;

        card.innerHTML = `
            <img src="${imageUrl}" alt="${product.title}" class="product-image">
            <h3 class="product-title">${translatedTitle}</h3>
            <div class="product-price">‚Ç¨ ${product.price}</div>
            ${isDigital ? `<div class="digital-tag"><i class="fa-solid fa-cloud-arrow-down"></i> ${t.digital_tag}</div>` : ''}
        `;
        return card;
    }

    function filterProducts() {
        const query = searchInput.value.toLowerCase().trim();
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        const filtered = ALL_PRODUCTS.filter(product => {
            // 1. –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const originalTitle = product.title.toLowerCase();
            const originalDescription = product.description.toLowerCase();

            // 2. –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
            const translatedTitle = (t.productTitles[product.id] || '').toLowerCase();
            const translatedDescription = (t.productDescriptions[product.id] || '').toLowerCase();

            // –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            return originalTitle.includes(query)
                || originalDescription.includes(query)
                || translatedTitle.includes(query) // –ü–æ–∏—Å–∫ –ø–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–º—É –∑–∞–≥–æ–ª–æ–≤–∫—É
                || translatedDescription.includes(query); // –ü–æ–∏—Å–∫ –ø–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é
        });

        DISPLAY_PRODUCTS = filtered;
        sortProducts(sortSelect.value, true);
    }

    function sortProducts(criteria, silent = false) {
        if (!silent) {
            sortSelect.value = criteria;
        }

        switch (criteria) {
            case 'price_asc':
                DISPLAY_PRODUCTS.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                break;
            case 'price_desc':
                DISPLAY_PRODUCTS.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                break;
            case 'default':
            default:
                DISPLAY_PRODUCTS.sort((a, b) => a.id - b.id);
                break;
        }

        renderProducts(DISPLAY_PRODUCTS);
    }


    // --- 5. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó API ---

    async function loadProducts() {
        const t = TRANSLATIONS[CURRENT_LANGUAGE];

        statusMessage.className = 'loading-message';
        statusMessage.textContent = t.status_loading;
        hideAllViews();

        try {
            const response = await fetch(API_URL);

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
                 throw new Error(data.error);
            }

            ALL_PRODUCTS = data.products.map(p => ({
                ...p,
                currency: 'EUR'
            }));
            DISPLAY_PRODUCTS = [...ALL_PRODUCTS];

            searchInput.placeholder = t.search_placeholder + ` (${ALL_PRODUCTS.length})`;

            statusMessage.style.display = 'none';
            showListView();
            updateCartCount();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            statusMessage.className = 'error-message';
            statusMessage.style.display = 'block';
            statusMessage.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i>
                                      ${t.status_error} ${error.message}.
                                      –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä FastAPI –∑–∞–ø—É—â–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É ${API_URL}.`;
        }
    }


    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

    document.getElementById('language-switcher').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.lang) {
            setLanguage(e.target.dataset.lang);
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    checkoutModal.addEventListener('click', (e) => {
        if (e.target.id === 'checkout-modal-overlay') {
            closeCheckoutModal();
        }
    });

    setLanguage(CURRENT_LANGUAGE);
    loadProducts();
</script>

</body>
</html>